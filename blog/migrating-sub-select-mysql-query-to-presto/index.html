<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Tomaz Tomazic"><link rel="shortcut icon" type=image/x-icon href=https://www.tomazic.pro/img/favicon.ico><title>Migrating sub-select MySQL query to Presto | Tomaz Tomazic</title><meta name=description content="When you have working SQL query there might not be so simple and straightforward it’s migration to Presto SQL. Recently I had a job to extract data from one table but with multiple added columns which requires sub-select. To demonstrate the problem and solution I have prepared simple user and location table where location entry represents where and where have users moved.
User +----+-------+ | id | name | +----+-------+ | 1 | Tom | | 2 | Sally | | 3 | Ben | +----+-------+ Location +----+---------+-------------+----------------------+ | id | user_id | name | moved_on | +----+---------+-------------+----------------------+ | 1 | 1 | 'New York' | '2010-1-1 00:00:00' | | 2 | 1 | 'Columbus' | '2011-1-1 00:00:00' | | 3 | 1 | 'Miami' | '2012-1-1 00:00:00' | | 4 | 2 | 'Miami' | '2010-1-1 00:00:00' | | 5 | 2 | 'Columbus' | '2011-1-1 00:00:00' | | 6 | 3 | 'Miami' | '2010-1-1 00:00:00' | | 7 | 3 | 'New York' | '2011-1-1 00:00:00' | +----+---------+-------------+----------------------+ Solution is using Presto’s window function"><link href=https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css rel=stylesheet integrity=sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl crossorigin=anonymous><link rel="preload stylesheet" href=/css/main.min.css as=style><link rel=stylesheet type=text/css href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet type=text/css href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,400,200bold,400old"><link rel=stylesheet href=/css/applause-button.css><script src=/js/applause-button.js></script><!--[if lt IE 9]><script src=https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js></script><script src=https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js></script><![endif]--><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','G-LQJ8L15S31','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><div id=content><div class="container mb-3"><nav class="navbar navbar-expand-lg"><div class=container-fluid><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbar aria-controls=navbar>
<i class="fa fa-bars"></i></button><div id=navbar class="collapse navbar-collapse"><ul class="navbar-nav ms-auto mb-2 mb-lg-0"><li class=nav-item><li><a class=nav-link href=/blog/>BLOG</a></li></li><li class=nav-item><li><a class=nav-link href=/resume/>RESUME</a></li></li></ul></div></div></div></nav><div class=container><h3 class=mt-3><b><a href=https://www.tomazic.pro/blog/migrating-sub-select-mysql-query-to-presto/>Migrating sub-select MySQL query to Presto</a></b></h3><div class="blog-title my-4"></div><div class=panel><div class=panel-body><div class=blogpost><p>When you have working SQL query there might not be so simple and straightforward it’s migration to Presto SQL. Recently I had a job to extract data from one table but with multiple added columns which requires sub-select. To demonstrate the problem and solution I have prepared simple <strong>user</strong> and <strong>location</strong> table where location entry represents where and where have users moved.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh>User
+----+-------+
<span style=color:#000;font-weight:700>|</span> id <span style=color:#000;font-weight:700>|</span> name  <span style=color:#000;font-weight:700>|</span>
+----+-------+
<span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span> Tom   <span style=color:#000;font-weight:700>|</span>
<span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>|</span> Sally <span style=color:#000;font-weight:700>|</span>
<span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>3</span> <span style=color:#000;font-weight:700>|</span> Ben   <span style=color:#000;font-weight:700>|</span>
+----+-------+
Location
+----+---------+-------------+----------------------+
<span style=color:#000;font-weight:700>|</span> id <span style=color:#000;font-weight:700>|</span> user_id <span style=color:#000;font-weight:700>|</span>     name    <span style=color:#000;font-weight:700>|</span>       moved_on       <span style=color:#000;font-weight:700>|</span>
+----+---------+-------------+----------------------+
<span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>  <span style=color:#4e9a06>&#39;New York&#39;</span> <span style=color:#000;font-weight:700>|</span>  <span style=color:#4e9a06>&#39;2010-1-1 00:00:00&#39;</span> <span style=color:#000;font-weight:700>|</span>
<span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>  <span style=color:#4e9a06>&#39;Columbus&#39;</span> <span style=color:#000;font-weight:700>|</span>  <span style=color:#4e9a06>&#39;2011-1-1 00:00:00&#39;</span> <span style=color:#000;font-weight:700>|</span>
<span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>3</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>  <span style=color:#4e9a06>&#39;Miami&#39;</span>    <span style=color:#000;font-weight:700>|</span>  <span style=color:#4e9a06>&#39;2012-1-1 00:00:00&#39;</span> <span style=color:#000;font-weight:700>|</span>
<span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>|</span>  <span style=color:#4e9a06>&#39;Miami&#39;</span>    <span style=color:#000;font-weight:700>|</span>  <span style=color:#4e9a06>&#39;2010-1-1 00:00:00&#39;</span> <span style=color:#000;font-weight:700>|</span>
<span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>5</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>|</span>  <span style=color:#4e9a06>&#39;Columbus&#39;</span> <span style=color:#000;font-weight:700>|</span>  <span style=color:#4e9a06>&#39;2011-1-1 00:00:00&#39;</span> <span style=color:#000;font-weight:700>|</span>
<span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>6</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>3</span> <span style=color:#000;font-weight:700>|</span>  <span style=color:#4e9a06>&#39;Miami&#39;</span>    <span style=color:#000;font-weight:700>|</span>  <span style=color:#4e9a06>&#39;2010-1-1 00:00:00&#39;</span> <span style=color:#000;font-weight:700>|</span>
<span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>7</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>3</span> <span style=color:#000;font-weight:700>|</span>  <span style=color:#4e9a06>&#39;New York&#39;</span> <span style=color:#000;font-weight:700>|</span>  <span style=color:#4e9a06>&#39;2011-1-1 00:00:00&#39;</span> <span style=color:#000;font-weight:700>|</span>
+----+---------+-------------+----------------------+
</code></pre></div><p>Solution is using Presto’s <a href=https://prestodb.io/docs/current/functions/window.html>window function</a></p><p><img src=/img/presto.png alt=presto></p><p>If you have trouble understanding windows functions by reading their docs, please continue reading this post and learn &ldquo;by example&rdquo;.</p><h2 id=task>Task</h2><p>Find all users who ever lived in Miami and display their current location and if their current location is Miami.</p><h2 id=postgresql>PostgreSQL</h2><p>PostgreSQL solution would look something like the first next code example. Note the <em>current_location</em> inside SELECT clause.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>SELECT</span> 
  <span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#000;font-weight:700>(</span>
    <span style=color:#204a87;font-weight:700>SELECT</span> <span style=color:#000>l</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>name</span>
    <span style=color:#204a87;font-weight:700>FROM</span> <span style=color:#204a87;font-weight:700>location</span> <span style=color:#000>l</span>
    <span style=color:#204a87;font-weight:700>WHERE</span> <span style=color:#204a87;font-weight:700>location</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>user_id</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>l</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>user_id</span>
    <span style=color:#204a87;font-weight:700>ORDER</span> <span style=color:#204a87;font-weight:700>BY</span> <span style=color:#000>l</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>moved_on</span> <span style=color:#204a87;font-weight:700>DESC</span>
    <span style=color:#204a87;font-weight:700>LIMIT</span> <span style=color:#0000cf;font-weight:700>1</span>
  <span style=color:#000;font-weight:700>)</span> <span style=color:#000>current_location</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>CASE</span> <span style=color:#204a87;font-weight:700>WHEN</span> 
    <span style=color:#204a87;font-weight:700>EXISTS</span> <span style=color:#000;font-weight:700>(</span>
      <span style=color:#204a87;font-weight:700>SELECT</span> <span style=color:#000>l</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>id</span> 
      <span style=color:#204a87;font-weight:700>FROM</span> <span style=color:#204a87;font-weight:700>location</span> <span style=color:#000>l</span>
      <span style=color:#204a87;font-weight:700>WHERE</span> 
        <span style=color:#204a87;font-weight:700>location</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>user_id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>l</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>user_id</span> <span style=color:#204a87;font-weight:700>AND</span> 
        <span style=color:#204a87;font-weight:700>location</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>moved_on</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>l</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>moved_on</span>
    <span style=color:#000;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>THEN</span> <span style=color:#4e9a06>&#39;True&#39;</span>
    <span style=color:#204a87;font-weight:700>ELSE</span> <span style=color:#4e9a06>&#39;False&#39;</span>
  <span style=color:#204a87;font-weight:700>END</span> <span style=color:#204a87;font-weight:700>AS</span> <span style=color:#000>is_miami_latest_location</span>
<span style=color:#204a87;font-weight:700>FROM</span> <span style=color:#204a87;font-weight:700>location</span>
<span style=color:#204a87;font-weight:700>JOIN</span> <span style=color:#4e9a06>&#34;user&#34;</span>
  <span style=color:#204a87;font-weight:700>ON</span> <span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>location</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>user_id</span>
<span style=color:#204a87;font-weight:700>WHERE</span>
  <span style=color:#204a87;font-weight:700>location</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;Miami&#39;</span>
<span style=color:#000;font-weight:700>;</span>
</code></pre></div><p>To test it out you can run postgreSQL in docker.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh>docker run --name pg -e <span style=color:#000>POSTGRES_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span>mysecretpassword -d postgres
docker <span style=color:#204a87>exec</span> -it pg psql -U postgres
</code></pre></div><p>Psql shell will pop up where you create and seed db.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>CREATE</span> <span style=color:#204a87;font-weight:700>DATABASE</span> <span style=color:#000>subquery</span>
<span style=color:#a40000>\</span><span style=color:#204a87;font-weight:700>c</span> <span style=color:#000>subquery</span>

<span style=color:#204a87;font-weight:700>CREATE</span> <span style=color:#204a87;font-weight:700>TABLE</span> <span style=color:#204a87;font-weight:700>IF</span> <span style=color:#204a87;font-weight:700>NOT</span> <span style=color:#204a87;font-weight:700>EXISTS</span> <span style=color:#4e9a06>&#34;user&#34;</span> <span style=color:#000;font-weight:700>(</span>
   <span style=color:#000>id</span> <span style=color:#204a87>INT</span> <span style=color:#204a87;font-weight:700>PRIMARY</span> <span style=color:#204a87;font-weight:700>KEY</span><span style=color:#000;font-weight:700>,</span>
   <span style=color:#000>name</span> <span style=color:#204a87>VARCHAR</span> <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>NOT</span> <span style=color:#204a87;font-weight:700>NULL</span>
<span style=color:#000;font-weight:700>);</span>


<span style=color:#204a87;font-weight:700>CREATE</span> <span style=color:#204a87;font-weight:700>TABLE</span> <span style=color:#204a87;font-weight:700>IF</span> <span style=color:#204a87;font-weight:700>NOT</span> <span style=color:#204a87;font-weight:700>EXISTS</span> <span style=color:#4e9a06>&#34;location&#34;</span> <span style=color:#000;font-weight:700>(</span>
   <span style=color:#000>id</span> <span style=color:#204a87>INT</span> <span style=color:#204a87;font-weight:700>PRIMARY</span> <span style=color:#204a87;font-weight:700>KEY</span><span style=color:#000;font-weight:700>,</span>
   <span style=color:#000>user_id</span> <span style=color:#204a87>INT</span> <span style=color:#204a87;font-weight:700>NOT</span> <span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span>
   <span style=color:#000>name</span> <span style=color:#204a87>VARCHAR</span> <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>NOT</span> <span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span>
   <span style=color:#000>moved_on</span> <span style=color:#204a87;font-weight:700>TIMESTAMP</span> <span style=color:#204a87;font-weight:700>NOT</span> <span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span>
   <span style=color:#204a87;font-weight:700>CONSTRAINT</span> <span style=color:#000>fk_user</span>
    <span style=color:#204a87;font-weight:700>FOREIGN</span> <span style=color:#204a87;font-weight:700>KEY</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>user_id</span><span style=color:#000;font-weight:700>)</span>
      <span style=color:#204a87;font-weight:700>REFERENCES</span> <span style=color:#4e9a06>&#34;user&#34;</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>);</span>

<span style=color:#204a87;font-weight:700>INSERT</span> <span style=color:#204a87;font-weight:700>INTO</span> <span style=color:#4e9a06>&#34;user&#34;</span> <span style=color:#204a87;font-weight:700>VALUES</span>
  <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;tom&#39;</span><span style=color:#000;font-weight:700>),</span>
  <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;sally&#39;</span><span style=color:#000;font-weight:700>),</span>
  <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;ben&#39;</span><span style=color:#000;font-weight:700>);</span>

<span style=color:#204a87;font-weight:700>INSERT</span> <span style=color:#204a87;font-weight:700>INTO</span> <span style=color:#204a87;font-weight:700>location</span> <span style=color:#204a87;font-weight:700>VALUES</span>
  <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;New York&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;2010-1-1 00:00:00&#39;</span><span style=color:#000;font-weight:700>),</span>
  <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;Columbus&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;2011-1-1 00:00:00&#39;</span><span style=color:#000;font-weight:700>),</span>
  <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;Miami&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;2012-1-1 00:00:00&#39;</span><span style=color:#000;font-weight:700>),</span>

  <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;Miami&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;2010-1-1 00:00:00&#39;</span><span style=color:#000;font-weight:700>),</span>
  <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;Columbus&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;2011-1-1 00:00:00&#39;</span><span style=color:#000;font-weight:700>),</span>

  <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;Miami&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;2010-1-1 00:00:00&#39;</span><span style=color:#000;font-weight:700>),</span>
  <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;New York&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;2011-1-1 00:00:00&#39;</span><span style=color:#000;font-weight:700>);</span>
</code></pre></div><h2 id=presto>Presto</h2><p>Solution in presto looks like the first next code example. See how I added WITH clause before SELECT clause and then used it with LEFT JOIN.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>WITH</span> <span style=color:#000>city</span> <span style=color:#204a87;font-weight:700>AS</span> <span style=color:#000;font-weight:700>(</span>
  <span style=color:#204a87;font-weight:700>SELECT</span> <span style=color:#000>user_id</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>moved_on</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#000>row_number</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000>over</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>partition</span> <span style=color:#204a87;font-weight:700>by</span> <span style=color:#000>user_id</span> <span style=color:#204a87;font-weight:700>order</span> <span style=color:#204a87;font-weight:700>by</span> <span style=color:#000>moved_on</span> <span style=color:#204a87;font-weight:700>desc</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>city_freshness</span>
  <span style=color:#204a87;font-weight:700>FROM</span> <span style=color:#204a87;font-weight:700>location</span>
<span style=color:#000;font-weight:700>),</span>

<span style=color:#000>latest_location</span> <span style=color:#204a87;font-weight:700>AS</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>SELECT</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#204a87;font-weight:700>FROM</span> <span style=color:#000>city</span> <span style=color:#204a87;font-weight:700>where</span> <span style=color:#000>city_freshness</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>SELECT</span> 
  <span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#000>latest_location</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>name</span> <span style=color:#204a87;font-weight:700>as</span> <span style=color:#000>current_location</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>CASE</span> <span style=color:#204a87;font-weight:700>WHEN</span> 
    <span style=color:#204a87;font-weight:700>EXISTS</span> <span style=color:#000;font-weight:700>(</span>
      <span style=color:#204a87;font-weight:700>SELECT</span> <span style=color:#000>l</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>id</span> 
      <span style=color:#204a87;font-weight:700>FROM</span> <span style=color:#204a87;font-weight:700>location</span> <span style=color:#000>l</span>
      <span style=color:#204a87;font-weight:700>WHERE</span> 
        <span style=color:#204a87;font-weight:700>location</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>user_id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>l</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>user_id</span> <span style=color:#204a87;font-weight:700>AND</span> 
        <span style=color:#204a87;font-weight:700>location</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>moved_on</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>l</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>moved_on</span>
    <span style=color:#000;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>THEN</span> <span style=color:#4e9a06>&#39;True&#39;</span>
    <span style=color:#204a87;font-weight:700>ELSE</span> <span style=color:#4e9a06>&#39;False&#39;</span>
  <span style=color:#204a87;font-weight:700>END</span> <span style=color:#204a87;font-weight:700>AS</span> <span style=color:#000>is_miami_latest_location</span>
<span style=color:#204a87;font-weight:700>FROM</span> <span style=color:#204a87;font-weight:700>location</span>
<span style=color:#204a87;font-weight:700>JOIN</span> <span style=color:#4e9a06>&#34;user&#34;</span>
  <span style=color:#204a87;font-weight:700>ON</span> <span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>location</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>user_id</span>
<span style=color:#204a87;font-weight:700>LEFT</span> <span style=color:#204a87;font-weight:700>join</span> <span style=color:#000>latest_location</span> <span style=color:#204a87;font-weight:700>on</span> <span style=color:#204a87;font-weight:700>location</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>user_id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>latest_location</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>user_id</span>
<span style=color:#204a87;font-weight:700>WHERE</span>
  <span style=color:#204a87;font-weight:700>location</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;Miami&#39;</span>
<span style=color:#000;font-weight:700>;</span>
</code></pre></div><p>To test it out you can run Presto in docker.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh>docker run --name presto ahanaio/prestodb-sandbox
docker <span style=color:#204a87>exec</span> -it presto presto-cli --catalog memory
</code></pre></div><p>Presto shell will pop up where you can create and seed db.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=color:#204a87;font-weight:700>CREATE</span> <span style=color:#204a87;font-weight:700>SCHEMA</span> <span style=color:#000>subquery</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000>USE</span> <span style=color:#000>subquery</span><span style=color:#000;font-weight:700>;</span>

<span style=color:#204a87;font-weight:700>CREATE</span> <span style=color:#204a87;font-weight:700>TABLE</span> <span style=color:#204a87;font-weight:700>IF</span> <span style=color:#204a87;font-weight:700>NOT</span> <span style=color:#204a87;font-weight:700>EXISTS</span> <span style=color:#4e9a06>&#34;user&#34;</span> <span style=color:#000;font-weight:700>(</span>
   <span style=color:#000>id</span> <span style=color:#204a87>INT</span><span style=color:#000;font-weight:700>,</span>
   <span style=color:#000>name</span> <span style=color:#204a87>VARCHAR</span> <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>);</span>

<span style=color:#204a87;font-weight:700>CREATE</span> <span style=color:#204a87;font-weight:700>TABLE</span> <span style=color:#204a87;font-weight:700>IF</span> <span style=color:#204a87;font-weight:700>NOT</span> <span style=color:#204a87;font-weight:700>EXISTS</span> <span style=color:#4e9a06>&#34;location&#34;</span> <span style=color:#000;font-weight:700>(</span>
   <span style=color:#000>id</span> <span style=color:#204a87>INT</span><span style=color:#000;font-weight:700>,</span>
   <span style=color:#000>user_id</span> <span style=color:#204a87>INT</span><span style=color:#000;font-weight:700>,</span>
   <span style=color:#000>name</span> <span style=color:#204a87>VARCHAR</span> <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#000;font-weight:700>),</span>
   <span style=color:#000>moved_on</span> <span style=color:#204a87;font-weight:700>TIMESTAMP</span>
<span style=color:#000;font-weight:700>);</span>

<span style=color:#204a87;font-weight:700>INSERT</span> <span style=color:#204a87;font-weight:700>INTO</span> <span style=color:#4e9a06>&#34;user&#34;</span> <span style=color:#204a87;font-weight:700>VALUES</span>
  <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;tom&#39;</span><span style=color:#000;font-weight:700>),</span>
  <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;sally&#39;</span><span style=color:#000;font-weight:700>),</span>
  <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;ben&#39;</span><span style=color:#000;font-weight:700>);</span>

<span style=color:#204a87;font-weight:700>INSERT</span> <span style=color:#204a87;font-weight:700>INTO</span> <span style=color:#204a87;font-weight:700>location</span> <span style=color:#204a87;font-weight:700>VALUES</span>
  <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;New York&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>TIMESTAMP</span> <span style=color:#4e9a06>&#39;2010-1-1 00:00:00&#39;</span><span style=color:#000;font-weight:700>),</span>
  <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;Columbus&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>TIMESTAMP</span> <span style=color:#4e9a06>&#39;2011-1-1 00:00:00&#39;</span><span style=color:#000;font-weight:700>),</span>
  <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;Miami&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>TIMESTAMP</span> <span style=color:#4e9a06>&#39;2012-1-1 00:00:00&#39;</span><span style=color:#000;font-weight:700>),</span>

  <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;Miami&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>TIMESTAMP</span> <span style=color:#4e9a06>&#39;2010-1-1 00:00:00&#39;</span><span style=color:#000;font-weight:700>),</span>
  <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;Columbus&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>TIMESTAMP</span> <span style=color:#4e9a06>&#39;2011-1-1 00:00:00&#39;</span><span style=color:#000;font-weight:700>),</span>

  <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;Miami&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>TIMESTAMP</span> <span style=color:#4e9a06>&#39;2010-1-1 00:00:00&#39;</span><span style=color:#000;font-weight:700>),</span>
  <span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;New York&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>TIMESTAMP</span> <span style=color:#4e9a06>&#39;2011-1-1 00:00:00&#39;</span><span style=color:#000;font-weight:700>);</span>
</code></pre></div><h2 id=solution-output>Solution output</h2><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh> id <span style=color:#000;font-weight:700>|</span> name  <span style=color:#000;font-weight:700>|</span> current_location <span style=color:#000;font-weight:700>|</span> is_miami_latest_location
----+-------+------------------+--------------------------
  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span> tom   <span style=color:#000;font-weight:700>|</span> Miami            <span style=color:#000;font-weight:700>|</span> True
  <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>|</span> sally <span style=color:#000;font-weight:700>|</span> Columbus         <span style=color:#000;font-weight:700>|</span> False
  <span style=color:#0000cf;font-weight:700>3</span> <span style=color:#000;font-weight:700>|</span> ben   <span style=color:#000;font-weight:700>|</span> New York         <span style=color:#000;font-weight:700>|</span> False
<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>3</span> rows<span style=color:#ce5c00;font-weight:700>)</span>
</code></pre></div><h2 id=conclusion>Conclusion</h2><p>Using window function in presto sql can be very powerful. I found this template very useful when querying data warehouse. I cannot learn it by heart therefore I copy it and slightly modify naming. I hope you will find it useful to copy & paste it as well. 😊</p></div><div class=blogpost__footer>March 26, 2022
&nbsp;&nbsp;
<span class="badge bg-success">sql</span>
<span class="badge bg-success">sub-select</span>
<span class="badge bg-success">presto</span></div></div><div class=applause><applause-button class=applause__button url=https://www.tomazic.pro/blog/migrating-sub-select-mysql-query-to-presto/ color=#22a8a1></div><div class=disqus><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"dcrystalj"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></div><footer class=footer><div class=container><div class=text-muted>&copy; All rights reserved 2022</div></div></footer><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.min.js integrity=sha384-nsg8ua9HAw1y0W1btsyWgBklPnCUAFLuTMS2G72MMONqmOymq585AcH49TLBQObG crossorigin=anonymous></script></body></html>