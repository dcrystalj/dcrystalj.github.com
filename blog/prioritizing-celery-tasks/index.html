<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Tomaž Tomažič"><link rel="shortcut icon" type=image/x-icon href=https://www.tomazic.pro/img/favicon.ico><title>Prioritizing celery tasks with different queues | dcrystalj</title><meta name=description content="When you have working SQL query there might not be so simple and straightforward it’s migration to Presto SQL. Recently I had a job to extract data from one table but with multiple added columns which requires sub-select. To demonstrate the problem and solution I have prepared simple **user** and **location** table where location entry represents where and where have users moved."><link href=https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css rel=stylesheet integrity=sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl crossorigin=anonymous><link rel="preload stylesheet" href=/css/main.min.css as=style><link rel=stylesheet type=text/css href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet type=text/css href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,400,200bold,400old"><link rel=stylesheet href=/css/applause-button.css><script src=/js/applause-button.js></script><!--[if lt IE 9]><script src=https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js></script>
<script src=https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js></script><![endif]-->
<link rel=stylesheet type=text/css href=https://www.tomazic.pro/css/vitae-skeleton.css><link rel=stylesheet type=text/css href=https://www.tomazic.pro/css/vitae-layout.css><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-LQJ8L15S31","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><div id=content><div class="container mb-3"><nav class="navbar navbar-expand-lg"><div class=container-fluid><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbar aria-controls=navbar>
<i class="fa fa-bars"></i></button><div id=navbar class="collapse navbar-collapse"><ul class="navbar-nav ms-auto mb-2 mb-lg-0"><li class=nav-item><li><a class=nav-link href=/blog/>BLOG</a></li></li><li class=nav-item><li><a class=nav-link href=/resume/>RESUME</a></li></li></ul></div></div></div></nav><div class=container><h3 class=mt-3><b><a href=https://www.tomazic.pro/blog/prioritizing-celery-tasks/>Prioritizing celery tasks with different queues</a></b></h3><div class="blog-title my-4"></div><div class=panel><div class=panel-body><div class=blogpost><p>Celery supports prioritization within each queue, but what if you want to reserve premium resource allocations for some tasks? You can move some traffic to other queue where worker with better resources take tasks from it.</p><h1 id=example>Example</h1><p>Lets say we have 2 functions <code>a</code> and <code>b</code>. We can set them default queues like <code>public</code> and <code>private</code> through task decorator correspondingly.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@app.task</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;public&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>a</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>print</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;Printing from fn &#39;a&#39;: </span><span style=color:#4e9a06>{</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>y</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5c35cc;font-weight:700>@app.task</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;private&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>b</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#000;font-weight:700>):</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>print</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>f</span><span style=color:#4e9a06>&#34;Printing from fn &#39;b&#39;: </span><span style=color:#4e9a06>{</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>y</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><p>We can run 2 workers, one for each queue and on different machines</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>celery -A tasks.app worker -Q public -l INFO  <span style=color:#8f5902;font-style:italic># machine 1</span>
</span></span><span style=display:flex><span>celery -A tasks.app worker -Q private -l INFO  <span style=color:#8f5902;font-style:italic># machine 2</span>
</span></span></code></pre></div><p>and schedule task by invoking function using <code>delay</code> or <code>apply_async</code> like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>delay</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span>  <span style=color:#8f5902;font-style:italic># Printing from fn &#39;a&#39;: 3 | public worker</span>
</span></span><span style=display:flex><span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>delay</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>)</span>  <span style=color:#8f5902;font-style:italic># Printing from fn &#39;b&#39;: 6 | private workder</span>
</span></span><span style=display:flex><span><span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>apply_async</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>],</span> <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;private&#34;</span><span style=color:#000;font-weight:700>)</span>  <span style=color:#8f5902;font-style:italic># Printing from fn &#39;a&#39;: 7 | private worker</span>
</span></span><span style=display:flex><span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>apply_async</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>args</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>],</span> <span style=color:#000>queue</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;public&#34;</span><span style=color:#000;font-weight:700>)</span>  <span style=color:#8f5902;font-style:italic># Printing from fn &#39;b&#39;: 20 | public worker</span>
</span></span></code></pre></div><p>Tasks will be processed by workers as written in comments. This allows you to process same task code on diferent workers, where task with higher prioriy can be executed on worker with better resources. Example: processing registered user vs. anonymous user data.</p><p>Here is the <code>docker compose</code> and <code>flower</code> output of whole POC <a href=https://github.com/dcrystalj/blog-code/tree/main/prioritizing-celery-tasks>example</a></p><pre tabindex=0><code class=language-log data-lang=log>...
public-worker-1   | [2022-11-27 18:19:56,784: INFO/MainProcess] Task tasks.a[25277467-1d4f-4b95-b915-d0ac7261a14a] received
public-worker-1   | [2022-11-27 18:19:56,786: WARNING/ForkPoolWorker-1] Printing from fn &#39;a&#39;: 3
private-worker-1  | [2022-11-27 18:19:56,786: INFO/MainProcess] Task tasks.b[32fa661f-706b-4139-a1cb-44d1e2c477a4] received
public-worker-1   | [2022-11-27 18:19:56,787: INFO/ForkPoolWorker-1] Task tasks.a[25277467-1d4f-4b95-b915-d0ac7261a14a] succeeded in 0.0016659999964758754s: None
private-worker-1  | [2022-11-27 18:19:56,788: INFO/MainProcess] Task tasks.a[fb61b60e-90e0-45cb-8fc6-edde1a431ffa] received
private-worker-1  | [2022-11-27 18:19:56,789: WARNING/ForkPoolWorker-3] Printing from fn &#39;a&#39;: 7
private-worker-1  | [2022-11-27 18:19:56,789: WARNING/ForkPoolWorker-1] Printing from fn &#39;b&#39;: 6
private-worker-1  | [2022-11-27 18:19:56,789: INFO/ForkPoolWorker-3] Task tasks.a[fb61b60e-90e0-45cb-8fc6-edde1a431ffa] succeeded in 0.0008720419136807323s: None
private-worker-1  | [2022-11-27 18:19:56,789: INFO/ForkPoolWorker-1] Task tasks.b[32fa661f-706b-4139-a1cb-44d1e2c477a4] succeeded in 0.0009083750192075968s: None
app-1             | Enqueing with default queue choice &#39;a&#39; -&gt; public
app-1             | Enqueing with default queue choice &#39;b&#39; -&gt; private
app-1             | Enqueing with overriden queue choice &#39;a&#39; -&gt; private
app-1             | Enqueing with overriden queue choice &#39;b&#39; -&gt; public
public-worker-1   | [2022-11-27 18:19:56,791: INFO/MainProcess] Task tasks.b[279c3ee7-b217-41e3-bb16-c4679cceabd2] received
public-worker-1   | [2022-11-27 18:19:56,791: WARNING/ForkPoolWorker-1] Printing from fn &#39;b&#39;: 20
public-worker-1   | [2022-11-27 18:19:56,791: INFO/ForkPoolWorker-1] Task tasks.b[279c3ee7-b217-41e3-bb16-c4679cceabd2] succeeded in 0.00010766694322228432s: None
app-1 exited with code 0
</code></pre><p><img src=/img/prioritizing-celery-tasks-flower.png alt=flower></p></div><div class=blogpost__footer>November 27, 2022
&nbsp;&nbsp;
<span class="badge bg-success">celery</span>
<span class="badge bg-success">queues</span></div></div><div class=applause><applause-button class=applause__button url=https://www.tomazic.pro/blog/prioritizing-celery-tasks/ color=#22a8a1></div><div class=disqus><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//dcrystalj.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></div><footer class=footer><div class=container><div class=text-muted>&copy; All rights reserved 2022</div></div></footer><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.min.js integrity=sha384-nsg8ua9HAw1y0W1btsyWgBklPnCUAFLuTMS2G72MMONqmOymq585AcH49TLBQObG crossorigin=anonymous></script></body></html>