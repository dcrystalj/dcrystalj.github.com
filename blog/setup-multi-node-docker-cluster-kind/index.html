<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Tomaž Tomažič"><link rel="shortcut icon" type=image/x-icon href=https://www.tomazic.pro/img/favicon.ico><title>Set-up multi node docker cluster with KIND | dcrystalj</title><meta name=description content="In this article I show exmaple how to access your exposed service via node port on Kind cluster."><link href=https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css rel=stylesheet integrity=sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl crossorigin=anonymous><link rel="preload stylesheet" href=/css/main.min.css as=style><link rel=stylesheet type=text/css href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet type=text/css href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,400,200bold,400old"><link rel=stylesheet href=/css/applause-button.css><script src=/js/applause-button.js></script><!--[if lt IE 9]><script src=https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js></script><script src=https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js></script><![endif]--><link rel=stylesheet type=text/css href=https://www.tomazic.pro/css/vitae-skeleton.css><link rel=stylesheet type=text/css href=https://www.tomazic.pro/css/vitae-layout.css><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','G-LQJ8L15S31','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><div id=content><div class="container mb-3"><nav class="navbar navbar-expand-lg"><div class=container-fluid><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbar aria-controls=navbar>
<i class="fa fa-bars"></i></button><div id=navbar class="collapse navbar-collapse"><ul class="navbar-nav ms-auto mb-2 mb-lg-0"><li class=nav-item><li><a class=nav-link href=/blog/>BLOG</a></li></li><li class=nav-item><li><a class=nav-link href=/resume/>RESUME</a></li></li></ul></div></div></div></nav><div class=container><h3 class=mt-3><b><a href=https://www.tomazic.pro/blog/setup-multi-node-docker-cluster-kind/>Set-up multi node docker cluster with KIND</a></b></h3><div class="blog-title my-4"></div><div class=panel><div class=panel-body><div class=blogpost><h1 id=why>Why</h1><p>Because when playing with kubernetes locally, I would like to see more realistic scenarios of having multiple nodes. By default <a href=https://kind.sigs.k8s.io/>Kind</a> comes with only one node.</p><p><img src=/img/kind/kind.png alt=kind></p><h1 id=setup>Setup</h1><ol><li>Create <code>~/kind.yaml</code> config (or whatever location you prefer).</li><li>Set content to</li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>Cluster<span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>kind.x-k8s.io/v1alpha4<span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>nodes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>control-plane<span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>extraPortMappings</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>containerPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>30303</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>hostPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8881</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>worker<span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>extraPortMappings</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>containerPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>30303</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>hostPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8882</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>worker<span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>extraPortMappings</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>containerPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>30303</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>hostPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8883</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><ol><li>Create new cluster with command <code>kind create cluster --config ~/kind.yaml</code>.</li><li>Note that every change of config requires cluster recreation.</li></ol><p>To verify your setup run <code>docker ps</code> where you should see proper port mapping for each &ldquo;node&rdquo; which is actually one docker container.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>CONTAINER ID   IMAGE                  COMMAND                  CREATED       STATUS       PORTS
                       NAMES
e037790892d0   kindest/node:v1.24.0   <span style=color:#4e9a06>&#34;/usr/local/bin/entr…&#34;</span>   <span style=color:#0000cf;font-weight:700>3</span> weeks ago   Up <span style=color:#0000cf;font-weight:700>2</span> weeks   0.0.0.0:8882-&gt;30303/tcp                              kind-worker
46c54b2558b0   kindest/node:v1.24.0   <span style=color:#4e9a06>&#34;/usr/local/bin/entr…&#34;</span>   <span style=color:#0000cf;font-weight:700>3</span> weeks ago   Up <span style=color:#0000cf;font-weight:700>2</span> weeks   127.0.0.1:45169-&gt;6443/tcp, 0.0.0.0:8881-&gt;30303/tcp   kind-control-plane
9d3b4e50247f   kindest/node:v1.24.0   <span style=color:#4e9a06>&#34;/usr/local/bin/entr…&#34;</span>   <span style=color:#0000cf;font-weight:700>3</span> weeks ago   Up <span style=color:#0000cf;font-weight:700>2</span> weeks   0.0.0.0:8883-&gt;30303/tcp                              kind-worker2
</code></pre></div><h1 id=expose---typenodeport>Expose &ndash;type=NodePort</h1><p>You can modify your setup ports however you like, but note you will want to have container ports higher than 30000 due to kubernetes default node port range (30000-32767). <code>containerPort</code> is the port where you can expose your pod <code>nodePort</code>, while <code>hostPort</code> is the port which will be exposed on the localhost.</p><h1 id=example>Example</h1><p>Let&rsquo;s create 3 deployments, which has visualization set in-place, if everything is working fine. This is used as example in great udemy course <a href=https://www.udemy.com/course/kubernetesmastery/>Kubernetes Mastery</a> by Bret Fisher.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>kubectl create deployment db --image<span style=color:#ce5c00;font-weight:700>=</span>bretfisher/wordsmith-db
kubectl create deployment web --image<span style=color:#ce5c00;font-weight:700>=</span>bretfisher/wordsmith-web
kubectl create deployment words --image<span style=color:#ce5c00;font-weight:700>=</span>bretfisher/wordsmith-words
</code></pre></div><p>Than we need to expose ports because our web is listening on port 80, api backend on 8080 and db on 5432.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>kubectl expose deployment db --port<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>5432</span>
kubectl expose deployment web --port<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>80</span>  --type<span style=color:#ce5c00;font-weight:700>=</span>NodePort
kubectl expose deployment words --port<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>8080</span>
</code></pre></div><p>Here we are using <a href=https://kubernetes.io/docs/concepts/services-networking/service/#type-nodeport>NodePort</a> for web because we would like to access web regardless of the cluster node we hit.</p><p>Now we need to edit config of web deployment because you cannot set <code>NodePort</code> directly as parameter when exposing!
Run <code>kubectl edit service web</code> and edit <code>nodePort: 30303</code> entry under <code>spec.ports</code>. You should have something like this</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml>...<span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>...<span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>	</span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline> 	</span>- <span style=color:#204a87;font-weight:700>nodePort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>30303</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>	  </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline> 	  </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>TCP<span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline> 	  </span><span style=color:#204a87;font-weight:700>targetPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>...<span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>You should be able to access web service by going to http://localhost:8881 or http://localhost:8882 or http://localhost:8883 and see the following image. <img src=/img/kind/docker-words.jpg alt="docker words image"> If you see empty LEGO bricks, something&rsquo;s wrong.
Node port is routing traffic to web server, because of our Kind config and NodePort service type.</p><p>This setup was tested on mac and windows WSL2.</p></div><div class=blogpost__footer>July 31, 2022
&nbsp;&nbsp;
<span class="badge bg-success">kind</span>
<span class="badge bg-success">k8s</span>
<span class="badge bg-success">docker</span></div></div><div class=applause><applause-button class=applause__button url=https://www.tomazic.pro/blog/setup-multi-node-docker-cluster-kind/ color=#22a8a1></div><div class=disqus><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"dcrystalj"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></div><footer class=footer><div class=container><div class=text-muted>&copy; All rights reserved 2022</div></div></footer><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.min.js integrity=sha384-nsg8ua9HAw1y0W1btsyWgBklPnCUAFLuTMS2G72MMONqmOymq585AcH49TLBQObG crossorigin=anonymous></script></body></html>