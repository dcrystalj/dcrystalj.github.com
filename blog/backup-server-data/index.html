<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Tomaž Tomažič"><link rel="shortcut icon" type=image/x-icon href=https://www.tomazic.pro/img/favicon.ico><title>Automating Data Backup: Protecting Your Critical Information and Peace of Mind | dcrystalj</title><meta name=description content=" Data loss is a real threat. Having home server is great but if you don't have it backed up you are risking losing all your data. You can lose data due to numerous things like hardware failure, ransomware, fire, theft, etc. To solve this problem, I am using restic which is open source, free and it supports incremental backups. It also supports encryption and it is quite easy to setup. It is written in go so it is quite fast and it has support for many different storage backends."><link href=https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css rel=stylesheet integrity=sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl crossorigin=anonymous><link rel="preload stylesheet" href=/css/main.min.css as=style><link rel=stylesheet type=text/css href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet type=text/css href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,400,200bold,400old"><link rel=stylesheet href=/css/applause-button.css><script src=/js/applause-button.js></script><!--[if lt IE 9]><script src=https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js></script>
<script src=https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js></script><![endif]-->
<link rel=stylesheet type=text/css href=https://www.tomazic.pro/css/vitae-skeleton.css><link rel=stylesheet type=text/css href=https://www.tomazic.pro/css/vitae-layout.css><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-LQJ8L15S31","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><div id=content><div class="container mb-3"><nav class="navbar navbar-expand-lg"><div class=container-fluid><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbar aria-controls=navbar>
<i class="fa fa-bars"></i></button><div id=navbar class="collapse navbar-collapse"><ul class="navbar-nav ms-auto mb-2 mb-lg-0"><li class=nav-item><li><a class=nav-link href=/blog/>BLOG</a></li></li><li class=nav-item><li><a class=nav-link href=/resume/>RESUME</a></li></li></ul></div></div></div></nav><div class=container><h3 class=mt-3><b><a href=https://www.tomazic.pro/blog/backup-server-data/>Automating Data Backup: Protecting Your Critical Information and Peace of Mind</a></b></h3><div class="blog-title my-4"></div><div class=panel><div class=panel-body><div class=blogpost><h1 id=data-loss-is-a-real-threat>Data loss is a real threat</h1><p>Having home server is great but if you don&rsquo;t have it backed up you are risking losing all your data. You can lose data due to numerous things like hardware failure, ransomware, fire, theft, etc. If you google up data backup people usually recommend having some kind of raid setup but this is not solving most of the disasters that can happen.</p><p><img src=/img/broken-backup.jpeg alt=backup></p><h1 id=physical-distance>Physical distance</h1><p>One of most reliable solutions is to have another server/storage in different physical location. You can have one server home and another installed at your parents&rsquo; house or at your office. Another option is to get some inexpensive cloud storage like <a href=https://www.backblaze.com/b2/cloud-storage.html>backblaze b2</a> or <a href=https://www.storj.io/>storj</a> and have your data backed up there. This is great solution but it can be quite expensive compared to second home server, especially if you have few terabytes of data.</p><h1 id=my-setup>My setup</h1><p>In my scenario I have 2 servers with main <em>NVMe</em> disk running OS and attached slower HDD drive. On both machines I am running ubuntu server. I would like to have data from <em>local server</em> HDD drive backed up to <em>remote server</em> HDD drive. I would like to have it automated and encrypted.</p><p>My disk is mounted with fstab (/etc/fstab) at boot with following line:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>/dev/sda2 /mnt/disk2 ext4 defaults <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span></code></pre></div><p>Let&rsquo;s call this machine <code>local</code> server.</p><h1 id=restic>Restic</h1><p>I have chosen <a href=https://restic.net/>restic</a> as my backup tool. It is open source, free and it supports incremental backups. It also supports encryption and it is quite easy to setup. It is written in <code>go</code> so it is quite fast and it has support for many different storage backends. Please give it a star on github if you like it.</p><h1 id=establish-connection>Establish connection</h1><p>First, we need to establish connection between <code>local</code> and <code>remote</code> server. We will use <code>ssh</code> for that. We will need to generate ssh key on <code>local</code> server and copy it to <code>remote</code> server. To prevent local server doing harm on remote server we will create new user on remote server and give him only permissions to read or write our backup directory.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># local server</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>REMOTE_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;100.xxx.xxx.xxx&#34;</span> <span style=color:#8f5902;font-style:italic># &lt;- write your remote server ip</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>BACKUP_DIR</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/mnt/disk2/backup&#34;</span> <span style=color:#8f5902;font-style:italic># &lt;- write your backup directory</span>
</span></span><span style=display:flex><span>ssh-keygen <span style=color:#8f5902;font-style:italic># keep pressing (defaults) to use no passphrase</span>
</span></span><span style=display:flex><span>cat ~/.ssh/id_rsa.pub
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># copy pubkey to cliboard</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># remote server</span>
</span></span><span style=display:flex><span>sudo groupadd backup
</span></span><span style=display:flex><span>sudo useradd -m backup
</span></span><span style=display:flex><span>sudo usermod -aG backup backup
</span></span><span style=display:flex><span>sudo su backup
</span></span><span style=display:flex><span>mkdir ~/.ssh
</span></span><span style=display:flex><span>touch ~/.ssh/authorized_keys
</span></span><span style=display:flex><span>chmod <span style=color:#0000cf;font-weight:700>700</span> ~/.ssh
</span></span><span style=display:flex><span>chmod <span style=color:#0000cf;font-weight:700>600</span> ~/.ssh/authorized_keys
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># paste pubkey from local server to ~/.ssh/authorized_keys</span>
</span></span></code></pre></div><p>Now you should test connection from local server to remote server with <code>ssh backup@${REMOTE_IP}</code>. If everything is ok, you should be able to login without password and close connection with <code>exit</code>.</p><h1 id=install-restic-and-setup-backup>Install restic and setup backup</h1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># local</span>
</span></span><span style=display:flex><span>sudo apt install restic
</span></span><span style=display:flex><span>restic init -r sftp:backup@<span style=color:#000>$REMOTE_IP</span>:/home/backup/restic init
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># save password to your password manager!</span>
</span></span><span style=display:flex><span><span style=color:#204a87>read</span> -p <span style=color:#4e9a06>&#34;Enter your repository password: &#34;</span> RESTIC_PASS
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># test it out</span>
</span></span><span style=display:flex><span><span style=color:#000>RESTIC_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$RESTIC_PASS</span> restic -r sftp:backup@<span style=color:#000>$REMOTE_IP</span>:/home/backup/restic backup <span style=color:#000>$BACKUP_DIR</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo mkdir /opt/backuper
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>whoami<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>sudo chown -R <span style=color:#000>$USER</span>:<span style=color:#000>$USER</span> /opt/backuper
</span></span><span style=display:flex><span>cat &gt; /opt/backuper/password <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>$RESTIC_PASS
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span><span style=display:flex><span>chmod <span style=color:#0000cf;font-weight:700>600</span> /opt/backuper/password
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat &gt; /opt/backuper/restic-backuper.sh <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>#!/usr/bin/env bash
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>set -euo pipefail
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>GOMAXPROCS=2 restic -p /opt/backuper/password -r sftp:backup@$REMOTE_IP:/home/backup/restic backup $BACKUP_DIR
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>GOMAXPROCS=2 restic -p /opt/backuper/password -r sftp:backup@$REMOTE_IP:/home/backup/restic forget --keep-daily 2 --keep-monthly 1 --prune
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span><span style=display:flex><span>chmod +x /opt/backuper/restic-backuper.sh
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># add to crontab to run during the night</span>
</span></span><span style=display:flex><span>crontab -e
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>0</span> <span style=color:#0000cf;font-weight:700>3</span> * * * /opt/backuper/restic-backuper.sh &gt;&gt; /opt/backuper/log
</span></span></code></pre></div><p>As you can see from script this will install restic tool, initialize remote repository in <code>/home/backup/restic</code> folder. It will create backup script in <code>/opt/backuper/</code> folder which will run every night at 3am and it will keep 2 daily and 1 monthly backups.</p><h1 id=restore>Restore</h1><p>Let&rsquo;s pretend your local server was destroyed. In this scenario you can create new one and do exact same steps as above. Then you can restore your data from remote server with following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>restic -p /opt/backuper/password -r sftp:backup@<span style=color:#000>$REMOTE_IP</span>:/home/backup/restic restore latest --target /
</span></span></code></pre></div><p>Test this command to make sure your backups are working properly!
Please make sure you read whole <a href=https://restic.readthedocs.io/en/latest/050_restore.html>documentationt</a> about <em>restore</em> as it has many options.</p></div><div class=blogpost__footer>May 16, 2023
&nbsp;&nbsp;
<span class="badge bg-success">backup</span>
<span class="badge bg-success">restic</span>
<span class="badge bg-success">umbrel</span></div></div><div class=applause><applause-button class=applause__button url=https://www.tomazic.pro/blog/backup-server-data/ color=#22a8a1></div><div class=disqus><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//dcrystalj.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></div><footer class=footer><div class=container><div class=text-muted>&copy; All rights reserved 2023</div></div></footer><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.min.js integrity=sha384-nsg8ua9HAw1y0W1btsyWgBklPnCUAFLuTMS2G72MMONqmOymq585AcH49TLBQObG crossorigin=anonymous></script></body></html>